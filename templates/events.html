{% extends "humat_base.html" %}

{% block title %}Etkinlik Takvimi{% endblock %}

{% block head_extra %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/events.css') }}?v=1.1">
{% endblock %}

{% block content %}
{% if current_user.is_authenticated and (current_user.is_admin or current_user.is_community_member) %}
<div class="container my-5">
  <div id="calendar-wrapper">
    <div id="calendar"></div>
  </div>
</div>
{% else %}
<div class="container my-5">
  <div class="alert alert-warning text-center">
    <i class="fas fa-lock fa-3x mb-3"></i>
    <h4>Etkinlik Takvimi Erişimi Kısıtlı</h4>
    <p>Etkinlik takvimine erişebilmek için admin yetkisine sahip olmalı veya topluluk üyesi olmalısınız.</p>
    {% if current_user.is_authenticated %}
    <a href="{{ url_for('community_register') }}" class="btn btn-primary">Topluluk Üyeliği İçin Başvur</a>
    {% else %}
    <a href="{{ url_for('login') }}" class="btn btn-primary me-2">Giriş Yap</a>
    <a href="{{ url_for('community_register') }}" class="btn btn-outline-primary">Topluluk Üyeliği İçin Başvur</a>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- Event Details Modal -->
<div class="modal fade" id="eventDetailModal" tabindex="-1" aria-labelledby="eventDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="eventDetailModalLabel"><i class="fas fa-calendar-day me-2"></i>Etkinlik Detayı</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <h4 id="eventTitle" class="mb-3"></h4>
        <p id="eventDescription" class="mb-4"></p>
        <div class="event-times">
          <div class="time-block">
            <i class="fas fa-hourglass-start"></i>
            <div>
              <strong>Başlangıç</strong>
              <span id="eventStart"></span>
            </div>
          </div>
          <div class="time-block">
            <i class="fas fa-hourglass-end"></i>
            <div>
              <strong>Bitiş</strong>
              <span id="eventEnd"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{% if current_user.is_authenticated and (current_user.is_admin or current_user.is_community_member) %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/tr.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
      locale: 'tr',
      initialView: window.innerWidth < 768 ? 'listWeek' : 'dayGridMonth',
      height: 'auto',
      aspectRatio: window.innerWidth < 768 ? 1.0 : 1.8,
      events: '{{ url_for("api_events") }}',
      headerToolbar: {
        left: window.innerWidth < 768 ? 'prev,next' : 'prev,next today',
        center: 'title',
        right: window.innerWidth < 768 ? 'dayGridMonth,listWeek' : 'dayGridMonth,timeGridWeek,listWeek'
      },
      buttonText: {
        today: 'Bugün',
        month: 'Ay',
        week: 'Hafta',
        day: 'Gün',
        list: 'Liste'
      },
      // Mobile responsive options
      windowResizeDelay: 100,
      eventDisplay: 'block',
      dayMaxEvents: window.innerWidth < 768 ? 2 : 3,
      moreLinkClick: 'listWeek',
      eventTimeFormat: {
        hour: '2-digit',
        minute: '2-digit',
        meridiem: false
      },
      eventDidMount: function (info) {
        // Truncate long event titles on mobile
        if (window.innerWidth < 768 && info.event.title.length > 15) {
          info.el.querySelector('.fc-event-title').textContent =
            info.event.title.substring(0, 12) + '...';
        }
      },
      eventClick: function (info) {
        info.jsEvent.preventDefault();
        var event = info.event;
        document.getElementById('eventTitle').textContent = event.title;
        document.getElementById('eventDescription').innerHTML = event.extendedProps.description || 'Açıklama yok.';

        const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        document.getElementById('eventStart').textContent = event.start ? new Date(event.start).toLocaleString('tr-TR', options) : 'Belirtilmemiş';
        document.getElementById('eventEnd').textContent = event.end ? new Date(event.end).toLocaleString('tr-TR', options) : 'Belirtilmemiş';

        var modal = new bootstrap.Modal(document.getElementById('eventDetailModal'));
        modal.show();
      }
    });
    calendar.render();

    // Handle window resize for responsive behavior
    window.addEventListener('resize', function () {
      const isMobile = window.innerWidth < 768;

      // Update calendar options based on screen size
      calendar.setOption('aspectRatio', isMobile ? 1.0 : 1.8);
      calendar.setOption('dayMaxEvents', isMobile ? 2 : 3);

      // Update header toolbar
      calendar.setOption('headerToolbar', {
        left: isMobile ? 'prev,next' : 'prev,next today',
        center: 'title',
        right: isMobile ? 'dayGridMonth,listWeek' : 'dayGridMonth,timeGridWeek,listWeek'
      });

      // Switch to list view on mobile if currently in week view
      if (isMobile && calendar.view.type === 'timeGridWeek') {
        calendar.changeView('listWeek');
      }
    });
  });
</script>
{% endif %}
{% endblock %}