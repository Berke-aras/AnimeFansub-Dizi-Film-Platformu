
{% extends "community_base.html" %}

{% block title %}{{ thread.title }}{% endblock %}

{% block community_content %}
<div class="forum-container">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('community.index') }}">Forum</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('community.view_category', category_id=thread.category.id) }}">{{ thread.category.name }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ thread.title|truncate(50) }}</li>
        </ol>
    </nav>

    <h2 class="mb-4">{{ thread.title }}</h2>

    <!-- Main Post -->
    <div class="post-card" id="post-{{ thread.id }}">
        <div class="post-user-panel">
            <i class="fas fa-user-circle"></i>
            <h5>{{ thread.user_username }}</h5>
            <span class="badge bg-primary">Konu Sahibi</span>
        </div>
        <div class="post-content-panel">
            <div class="post-header">
                {{ thread.timestamp.strftime('%d-%m-%Y %H:%M') }}
            </div>
            <div class="post-body ck-content">
                {{ thread.content|safe }}
            </div>
            <div class="post-footer">
                {% if current_user.is_authenticated and (current_user.id == thread.user_id or current_user.is_admin) %}
                    <form action="{{ url_for('community.delete_thread', thread_id=thread.id) }}" method="post" onsubmit="return confirm('Bu konuyu silmek istediğinizden emin misiniz?');">
                        <button type="submit" class="btn btn-sm btn-danger"><i class="fas fa-trash"></i> Sil</button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Replies -->
    <h4 class="mb-3">Cevaplar ({{ posts|length }})</h4>
    {% for post in posts %}
    <div class="post-card" id="post-{{ post.id }}">
        <div class="post-user-panel">
            <i class="fas fa-user-circle"></i>
            <h5>{{ post.user_username }}</h5>
        </div>
        <div class="post-content-panel">
            <div class="post-header">
                {{ post.timestamp.strftime('%d-%m-%Y %H:%M') }}
            </div>
            <div class="post-body ck-content">
                {{ post.content|safe }}
            </div>
            <div class="post-footer">
                 {% if current_user.is_authenticated and (current_user.id == post.user_id or current_user.is_admin) %}
                    <form action="{{ url_for('community.delete_post', post_id=post.id) }}" method="post" onsubmit="return confirm('Bu cevabı silmek istediğinizden emin misiniz?');">
                        <button type="submit" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Reply Form -->
    {% if current_user.is_authenticated %}
    <div class="card mt-4">
        <div class="card-header">
            <h5>Bir Cevap Yaz</h5>
        </div>
        <div class="card-body">
            <form action="{{ url_for('community.new_post', thread_id=thread.id) }}" method="post">
                <div class="mb-3">
                    <textarea id="content" name="content"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Cevabı Gönder</button>
            </form>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info mt-4">
        Cevap yazabilmek için <a href="{{ url_for('login', next=request.url) }}">giriş yapmalısınız</a>.
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
{% if current_user.is_authenticated %}
<script src="https://cdn.ckeditor.com/ckeditor5/35.4.0/classic/ckeditor.js"></script>
<script>
    ClassicEditor
        .create( document.querySelector( '#content' ), {
            // CKEditor configuration can go here
        } )
        .catch( error => {
            console.error( error );
        } );
</script>
{% endif %}
{% endblock %}
